$(function () {
        
     Highcharts.setOptions({
        global: {
            useUTC: false
        },
     });
    
    
    var finance = new Finance();
    
    function NPV (rate,arguments) {
        var rate = rate/100, npv = arguments[0];
        for (var i = 1; i < arguments.length; i++) {
          npv +=(arguments[i] / Math.pow((1 + rate), i));
        }
        return Math.round(npv * 100) / 100;
    };
    
    //CHART TIR
            
    var contentFilter =  $('.content_filter_investment');
    
    $('body').on('submit', '.form-investments', function (e) {
        e.preventDefault();                
        var form = new FormData(this);
        
        $.ajax({
            url: SITEURL + "/indicators/getChartInvestment",
            dataType: 'json',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false,
                beforeSend: function () {
                $(".preload").fadeIn(300);
            },
            success: function (result) {
                $(".preload").fadeOut(300);
                toastr[result.status](result.msg);
                if (result.status == "success") { 
                    
                    $('#data-total').html(result.model.total_format);
                    $('#data-count').html(result.model.count);
                    $('#import-lot').val(result.model.lot);
                    $('#import-rate').val(result.model.rate);
                    $('#import-value').val(result.model.value);
                    $('#import-count').val(result.model.count);
                    
                    setTimeout(function () {
//                        location.reload();
                        $('#load_db').openModal();
                    }, 200);
                    
                }
            }
        });
        
    }); 
    
    $('body').on('submit', '.form-analice-data', function (e) {
        e.preventDefault();
        var form = new FormData(this);
        $.ajax({
            url: SITEURL + "/indicators/analiceData",
            dataType: 'json',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false,
            beforeSend: function () {
                $(".preload").fadeIn(300);
            },
            success: function (result) {
                $(".preload").fadeOut(300);
//                console.log(result);
                if(result.status == 'success'){ 
                    //CHART FLUJO
                    createChart(result);                    
                    
                    //TIR
                    let originalInvestment = (-1*form.get("value"));
                    var flow = result.data;
                    flow.splice(0, 0, originalInvestment);
                    
                    // IRR
                    var tir = finance.IRR.apply(this, flow);
                    
                    //CHART TIR
                        var base = 30;
                        var x = [];
                        var y = [];
                        var van = 0;
                        var rate = 0;
                        var tirBase = Math.ceil(tir - base);
                        
                        for (var i = 0; i <= ((base*2)+1); i++) { 
                            
                            var a = tirBase-1;
                            var b = tirBase+1;
                            rate = (((tir > a) && (tir < b) && ((b - tir) < 1)) || tirBase == tir)? tir : tirBase;
                            y[i] = rate;
                            van = NPV(rate, flow);
                            van = (rate == tir)? 0 : van;   
                            
                            x[i] = (van == 0)? {marker: {fillColor: '#FF0000',lineWidth: 3,lineColor: "#FF0000",enabled: true,},x: rate,y:van} : {x: rate,y:van};
                            tirBase++;
                        }
                           
                    createChartTIR(x);
                    
                    $('#tir-txt').html(tir+ ' %');  
                        
                    //VAN
                    $('#van-txt').html('$ '+finance.PV(tir, form.get("value"), form.get("count")));

                    
                    // VF
                    $('#vf-txt').html('$ '+finance.FV(tir, form.get("value"), form.get("count"))); 
                    //$('#vf-txt').html('$ '+finance.FV(form.get("rate"), form.get("value"), form.get("count"))); 
                    
                    //ROI
                    $('#roi-txt').html(finance.ROI(form.get("value"), (result.earnings - form.get("value")))+'%'); 
                                        
                    //show results
                    $('#investment-van, #investment-tir, #investment-vf, #investment-roi').removeClass('hide');
                    
                    setTimeout(function () {
                        $('.btn-filter-invest').trigger('click');
                        $(".form-investments")[0].reset();
                        $('#load_db').closeModal();
                    }, 200);
                }else{
                  toastr[result.status](result.msg);  
                }
                
            }
        });
    });
    
    $('body').on('click','.btn-filter-invest',function(e){
        e.preventDefault();
        var _this = $(this);
        if(!_this.hasClass('active')){
            contentFilter.removeClass('hide').fadeIn('slow');
            _this.addClass('active');
        }else{
            contentFilter.fadeOut(100).addClass('hide');
            _this.removeClass('active');
        }
    });  
    
    /**
     * Create the chart when all data is loaded
     * @returns {undefined}
     */
    function createChart(result) {              
        //title = result.title;

        Highcharts.chart('canvas-5', {
            chart: {
                type: 'spline'
            },
            title: {
                text: 'FLUJO'
            },
            xAxis: {
                categories: result.category
            },
            yAxis: {
                title: {
                    text: 'Valor'
                }
            },
            tooltip: {
                crosshairs: true,
                shared: true
            },
            plotOptions: {
                spline: {
                    marker: {
                        radius: 4,
                        lineColor: '#666666',
                        lineWidth: 1
                    }
                }
            },
            series: [{
                name: 'FLUJO',
                marker: {
                    symbol: 'square'
                },
                data: result.data,
                showInLegend: false

            }]
        });

        setTimeout(function(){
            $('.highcharts-credits').fadeOut('slow');
            $('#canvas-5').removeClass('hide');
        },500);
    }

    //CHART TIR
    
    function createChartTIR(x){              
        //title = result.title;
        Highcharts.chart('canvas-6', {
            chart: {
                type: 'spline'
            },
            title: {
                text: 'TIR'
            },            
            xAxis: {
                title: {
                    text: 'TASA DE DESCUENTO(%)'
                },
                labels: {
                    formatter: function() {
                      return this.value + '%';
                    }
                  }
            },
            yAxis: {
                title: {
                    text: 'VAN($)'
                }
            },
            tooltip: {
                        useHTML: true,
                        formatter: function() {
                            return '<b>' + this.x + ' %</b><br><span>' + Highcharts.numberFormat(this.y,0,'.',',') + '</span>'
                        }
                    },
            plotOptions: {
                spline: {
                    marker: {
                        radius: 4,
                        lineColor: '#68CC03',
                        lineWidth: 1
                    },
                    color : '#68CC03',
                    
                }
            },
            series: [{  
                name: '',                
                marker: {
                    symbol: 'square'
                },
                data: x,
                showInLegend: false
            }]
        });

        setTimeout(function(){
            $('.highcharts-credits').fadeOut('slow');
            $('#canvas-6').removeClass('hide');
        },500);
    }

    //createChart();
    var result = {
                    "category": [
                        
                    ],
                    "data": [
                        
                    ],
                };
    console.log(result);                
    createChart(result);
    createChartTIR(result.data);       
        
    $('body').on('change', '.form-indicators', function (e) {
        e.preventDefault();
        createChart();
    });  
      
});
$(window).on('load', function() {
    //
    $('.content-investment').addClass('hide');
    setTimeout(function(){
        $('#m-wallets').trigger('click');
        $('#m-investments').addClass('active');
    },250);
    
});


