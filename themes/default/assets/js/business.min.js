$(function () { 
    
    //btn see more items legal
    $('.see-more').click(function(e){
        e.preventDefault();
        var _this = $(this);
        var attr = _this.attr('data-page');        
        var idState = _this.parent().siblings('.connectedSortable').attr('id');                
        _this.parent().addClass("hide");
        _this.next().removeClass("hide");

        // For some browsers, `attr` is undefined; for others, `attr` is false. Check for both.
        if (typeof attr !== typeof undefined && attr !== false) {
          // Element has this attribute
            $('#form-filter-page').val(attr).change();
        }           
        getBusiness(_this,idState);
    });
        
    $('body').on('change','.select-tasksSupport',function(e){
        e.preventDefault();        
        var _this = $(this);
        var element = "#"+_this.closest("form").attr("data-id");  
        
        if($(element+'idTasksAction').val() == 12 || $(element+'idTasksAction').val() == 6 || $(element+'idTasksAction').val() == 9 || $(element+'idTasksAction').val() == 21 || $(element+'idTasksAction').val() == 29){ 
            if($(element+'idTasksAction').val() == 6|| $(element+'idTasksAction').val() == 9){
                //$(element+'support').removeAttr( "multiple" );
            }else{
                //$(element+'support').attr('multiple',true);
            }
            $("#file-task").removeClass('hide');
        }else{
            $("#file-task").addClass('hide');            
        }
        
        if($(element+'idTasksAction').val() == 1 || $(element+'idTasksAction').val() == 12){
            $(element+'is_contact').attr('disabled',false);
        }else{
            $(element+'is_contact').attr('disabled',true);            
        }
        
    });   
    
    $('body').on('click', '.viewSupportManagement', function (e) {
        e.preventDefault();
        var _this = $(this);
        $.ajax({
            url: SITEURL + '/business/getSupportManagementBusiness',
            dataType: 'json',
            type: 'POST',
            data: {idTasks : _this.attr('data-idTask')},
            beforeSend: function(){
                $("#suport-management").empty();
            },
            success: function(result){
                $("#suport-management").html(result.html);
//                    $('.slider').slider();
                $('#suport-management .materialboxed').materialbox();
                $(".modal_clic").leanModal();
            }
        });

    });
    
    /* NEW BUSINESS */
    
        $('body').on('submit', '.form-business', function (e) {
            e.preventDefault();
            var form = new FormData(this);
            $.ajax({
                url: SITEURL + "/business/updateBusiness",
                dataType: 'json',
                type: 'POST',
                data: form,
                processData: false,
                contentType: false,
                beforeSend: function () {
                    $(".preload").fadeIn(300);
                },
                success: function (result) {
                    $(".preload").fadeOut(300);
                    toastr[result.status](result.msg);
                    if (result.status == "success") {
                        $('.clear').val('');
                        $('.modal-close').click();
                        setTimeout(function () {
                            location.reload();
                        }, 800);
                    }
                }
            });
        });
        
    /* TASKS */

        $('body').on('submit', '.form-business-tasks', function (e) {
        e.preventDefault();
        var form = new FormData(this);

        $.ajax({
            url: SITEURL + "/business/saveTasks",
            dataType: 'json',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false,
            beforeSend: function () {
                $(".preload").fadeIn(300);
            },
            success: function (result) {
                $(".preload").fadeOut(300);
                toastr[result.status](result.msg);
                if (result.status == "success") {
                    $(".form-business-tasks")[0].reset();
                    var content = (result.model.idTasksAction != 19 && result.model.idTasksAction != 12 && result.model.idTasksAction != 1 && result.model.idTasksAction != 9 && result.model.idTasksAction != 6) ? '#content-task-0' : '#content-task-' + result.model.idTasksAction;
                    if (result.newRecord) {
                        $(content).prepend(result.html);
                    } else {
                        $('#itemTasksBusiness-' + result.model.id).replaceWith(result.html);
                    }
                    $(content).parent().parent().parent().removeClass('hide');
                    location.reload();
                    actionModal();
                }
            }
        });
        return false;
    }); 
    
    /* PHONES BUSINESS */
    
        // btn create phone wallet

        $('body').on('click', '#btnNewPhone', function (e) {
            e.preventDefault();
            var _this = $(this);
            $(".form-userPhone")[0].reset();
            $("#phones-id").val('');
            $("#phones-idUser").val(_this.attr('data-idUser'));
        });
        
        // btn update phone wallet

        $('body').on('click', '.editUserPhone', function (e) {    
            e.preventDefault();
            var _this = $(this);
            $("#new_phone_modal #phones-id").val(_this.attr('data-id'));
            $("#new_phone_modal #phones-idUser").val(_this.attr('data-idUser'));
            $("#new_phone_modal #phones-number").val(_this.attr('data-number'));
            $("#new_phone_modal #phones-comment").val(_this.attr('data-comment'));
            $("#new_phone_modal #phones-active").val(_this.attr('data-active'));
            $("#new_phone_modal #phones-idTypeReference").val(_this.attr('data-idTypeReference')).trigger('change');
            $("#new_phone_modal #phones-idPhoneClass").val(_this.attr('data-idPhoneClass')).trigger('change');
            $("#new_phone_modal #phones-idCountry").val(_this.attr('data-idCountry')).trigger('change');
            setTimeout(function () {
                $("#new_phone_modal #phones-idDepartment").val(_this.attr('data-idDepartment')).trigger('change');
            }, 500);
            setTimeout(function () {
                $("#new_phone_modal #phones-idCity").val(_this.attr('data-idCity'));
            }, 1000);


        });
        
        //  form create/update address wallets

        $('body').on('submit', '.form-userPhone', function (e) {
            e.preventDefault();
            var form = new FormData(this);
            $.ajax({
                url: SITEURL + "/business/saveDemographicPhone",
                dataType: 'json',
                type: 'POST',
                data: form,
                processData: false,
                contentType: false,
                beforeSend: function () {
                    $(".preload").fadeIn(300);
                },
                success: function (result) {
                    $(".preload").fadeOut(300);
                    toastr[result.status](result.msg);
                    if (result.status == "success") {
                        if (result.newRecord) {
                            $('#userPhones-' + result.model.idUser).append(result.html);
                        } else {
                            $('#itemDemographicUserPhone-' + result.model.id).replaceWith(result.html);
                        }
                        actionModal();
                        if (!$('.userPhone').hasClass("activoAcordeon")) {
                            $('.userPhone').click();
                        }
                        $('.modal-close').click();
                    }
                }
            });
        });
        
    /* EMAIL USERS */
    
        // btn create address users

        $('body').on('click', '#btnNewEmail', function (e) {
            e.preventDefault();
            var _this = $(this);
            $(".form-userEmail")[0].reset();
            $("#email-id").val('');
            $("#email-idUser").val(_this.attr('data-idUser'));
        });
        
        // btn update email wallet

        $('body').on('click', '.editEmail', function (e) {    
            e.preventDefault();
            var _this = $(this);

            $("#new_correo_modal #email-id").val(_this.attr('data-id'));
            $("#new_correo_modal #email-idUser").val(_this.attr('data-idUser'));
            $("#new_correo_modal #email-name").val(_this.attr('data-name'));
            $("#new_correo_modal #email-email").val(_this.attr('data-email'));
            $("#new_correo_modal #email-comment").val(_this.attr('data-comment'));
            $("#new_correo_modal #email-active").val(_this.attr('data-active'));
            $("#new_correo_modal #email-idTypeReference").val(_this.attr('data-idTypeReference')).trigger('change');
        });
                
        //  form create/update address wallets

        $('body').on('submit', '.form-userEmail', function (e) {
            e.preventDefault();
            var form = new FormData(this);
            $.ajax({
                url: SITEURL + "/business/saveDemographicEmail",
                dataType: 'json',
                type: 'POST',
                data: form,
                processData: false,
                contentType: false,
                beforeSend: function () {
                    $(".preload").fadeIn(300);
                },
                success: function (result) {
                    $(".preload").fadeOut(300);
                    toastr[result.status](result.msg);
                    if (result.status == "success") {
                        if (result.newRecord) {
                            $('#userEmail-' + result.model.idUser).append(result.html);
                        } else {
                            $('#itemDemographicUserEmail-' + result.model.id).replaceWith(result.html);
                        }
                        actionModal();
                        if (!$('.userEmail').hasClass("activoAcordeon")) {
                            $('.userEmail').click();
                        }
                        $('.modal-close').click();
                    }
                }
            });
            return false;
        });
        
    /* SPENDING */ 
     
        $('body').on('click', '.btn-spending', function (e) {
            var _this = $(this);            
            $(".form-spending")[0].reset();
            $("#spending-id").val('');                      
            
        });
    
        //    form spendngs business

        $('body').on('submit', '.form-spending', function (e) {
            e.preventDefault();
            var form = new FormData(this);
            $.ajax({
                url: SITEURL + "/business/saveSpending",
                dataType: 'json',
                type: 'POST',
                data: form,
                processData: false,
                contentType: false,
                beforeSend: function () {
                    $(".preload").fadeIn(300);
                },
                success: function (result) {
                    $(".preload").fadeOut(300);
                    toastr[result.status](result.msg);
                    if (result.status == "success") {
                        if (result.newRecord) {
                            $('#businessSpending-' + result.model.idUserBusiness).append(result.html);
                        } else {
                            $('#itemBusinessSpending-' + result.model.id).replaceWith(result.html);
                        }
                        actionModal();
                        $('.modal-close').click();
                    }
                }
            });
            return false;
        });
        
        // btn update spending business

            $('body').on('click', '.editSpending', function (e) {    
                e.preventDefault();
                var _this = $(this);
                $('#new_spending_business_modal #spending-idUserBusiness').val(_this.attr('data-idUserBusiness'));
                $('#new_spending_business_modal #spending-id').val(_this.attr('data-id'));
                $("#new_spending_business_modal #spending-dateSpending").val(_this.attr('data-spendingDate'));
                $("#new_spending_business_modal #spending-comments").val(_this.attr('data-spendingComments'));                
                $("#new_spending_business_modal #spending-value").val(_this.attr('data-spendingValue'));                            
                $("#new_spending_business_modal #spending-idSpendingType").val(_this.attr('data-idSpendingType'));
                $("#new_spending_business_modal #spending-idCountry").val(_this.attr('data-idCountry')).trigger('change');
                setTimeout(function () {
                    $("#new_spending_business_modal #spending-idDepartment").val(_this.attr('data-idDepartment')).trigger('change');
                }, 500);
                 setTimeout(function () {
                    $("#new_spending_business_modal #spending-idCity").val(_this.attr('data-idCity'));
                }, 1000);
            });
            
});

/* FUNTIONS */


// recursos para cargas despues de un ajax
function actionModal() {
//    $(".tooltipped").tooltip();
    $(".modal_clic").leanModal();
}

function getBusiness(_this,idState){
        var formElement = document.getElementById('form-filter-business');
        var form = new FormData(formElement); 
        form.append("idState", idState);

        $.ajax({
            url: SITEURL + '/business/index',
            dataType: 'json',
            method: 'POST',
            data: form,
            processData: false,
            contentType: false,
            success: function(result) {
                if(result.status == "success"){
                    $("#form-filter-page").val('1');
                    _this.attr('data-page',result.page);                    
                    $('#'+result.id).append(result.html);                    
                    if(result.more){
                        $(_this).parent().removeClass('hide');
                        $(_this).next().addClass('hide');
                    }else{
                        $(_this).parent().addClass('hide');
                        $(_this).next().addClass('hide');
                    }
                }
            }
        });
    }

$(window).on('load', function() {
    setTimeout(function () {
        $('#m-wallets').trigger('click');
        $('#m-business').addClass('active');
    }, 250);    
});