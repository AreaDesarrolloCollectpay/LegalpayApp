$(function () {
    $('#m-maps').addClass('active');
    $('#m-users').removeClass('active');
    
    var markers = [];
    var map;
    var markerCluster;
    var locations = [];   
    var infowindow;
    
    map = new google.maps.Map(document.getElementById('map'), {
        zoom: 5,
        minZoom: 3,
        center: {lat: 4.710989, lng: -74.072092},
        fullscreenControl: false,
        styles: [
                    {
                        "featureType": "administrative.country",
                        "elementType": "geometry",
                        "stylers": [
                            {
                                "visibility": "simplified"
                            },
                            {
                                "hue": "#ff0000"
                            }
                        ]
                    }
                ]
    });
    
    window.onload = function () {
        
        getMaps(0);
        
         $('body').on('change', '.form-maps', function (e) {
            e.preventDefault();
            getMaps(1);
        });   
    }
    
    
    function getMaps(state){
        var formElement = document.querySelector(".form-filter-maps");
        var form = new FormData(formElement); 
        map.setZoom(5);
        
        if(state != 0){
            markerCluster.removeMarkers(markers);
            markers = [];
        }
        
        $.ajax({
            url: SITEURL + "/maps/GetMapsBusiness",
            async: false,
            dataType: 'json',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false,
            success: function (result) {
                locations = result.locations; 
                //console.log(result.locations);
            }
        });
        
        infowindow = new google.maps.InfoWindow();
        
        locations.map(function (location, i) {
            var marker = new google.maps.Marker({
                position: {lat: parseFloat(location.lat), lng: parseFloat(location.lng)},
                label: location.title,
                map: map,
            });
            var style = 'color:#131313;font-weight:bold';
            var contentString = '<div class="infowindows">'+
                '<p><span style="'+style+'">'+location.name+'</span></p>'+
                '<p><span style="'+style+'">CC / NIT :</span> '+location.code+'</p>'+
                '<p><span style="'+style+'">Direcci√≥n :</span> '+location.address+'</p>'+
                '<span style="font-weight:bold;"><a href="'+SITEURL+'/business/detail/'+location.id+'"> Ver <i class="fa fa-angle-double-right" aria-hidden="true"></i></a></span>'+
            '</div>';
            google.maps.event.addListener(marker, 'click', (function (marker, i) {
                return function () {
                    infowindow.setContent(contentString);
                    infowindow.setOptions({maxWidth: 300});
                    infowindow.open(map, marker);
                }
            })(marker, i));
            markers.push(marker);
        });
        markerCluster = new MarkerClusterer(map, markers,
            {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
    }    
});


