$(function () {    
    // btn create customers 

        $('body').on('click', '.createCustomers', function (e) {
            e.preventDefault();
            var _this = $(this);
            $(".form-customers")[0].reset();
            $("#customers-id").val('');        
            $('#customers-support_bank_file').attr('href','#').addClass('hide');   
        });

    //  form update User

    $('body').on('submit', '.form-customers', function (e) {
        e.preventDefault();
        var form = new FormData(this);
        $.ajax({
            url: SITEURL + "/customers/updateCustomers",
            dataType: 'json',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false,
            beforeSend: function () {
                $(".preload").fadeIn(300);
            },
            success: function (result) {
                $(".preload").fadeOut(300);
                toastr[result.status](result.msg);
                if (result.status == "success") {
                    $('.clear').val('');
                    $('.modal-close').click();
                    setTimeout(function(){
                        location.reload();
                    },800);
                }
            }
        });
    });
    
    // search Coordinators
    
    $('body').on('change','.searchCustomers',function(){
        var i = 0;
        var urlExplorar = ''
            $('.searchCustomers').each(function(){
                var _this = $(this);                        
                
                if(_this.val() != ''){                    
                    urlExplorar += (i == 0)? '?'+_this.attr('name')+'='+_this.val() : '&'+_this.attr('name')+'='+_this.val() ;
                    i++;
                }
                
            });                        
            window.location = SITEURL+'/customers'+urlExplorar;
            return false;
    });
        
    // update Customers
    
    $('body').on('click', '.editCustomers', function (e) {
        e.preventDefault();
        var _this = $(this);
        var element = "#"+_this.attr("data-element");
        $(element+'support_bank').parent().siblings().children().val('');        
        $(element+'support_bank_file').attr('href','#').addClass('hide');       
        $.ajax({
            url: SITEURL + "/customers/getCustomer",
            dataType: 'json',
            type: 'POST',
            data: {id : _this.attr("data-id")},
            success: function (result) {
                if (result.status == "success"){
                    if(result.customer_info != null){
                        $.each(result.customer_info,function(index, value){
                            if(value != '' && index != 'support_bank'){                                
                               $(element+index).val(value);
                            }
                        }); 
                    }
                    $.each(result.model,function(index, value){
                        $(element+index).val(value);
                    });
                    
                    if(result.location.idCity != ''){
                        setTimeout(function () {
                            $(element+'idCountry').val(result.location.idCountry).trigger('change');
                            setTimeout(function () {
                               $(element+'idDepartment').val(result.location.idDepartment).trigger('change');
                                setTimeout(function () {
                                   $(element+'idCity').val(result.location.idCity).trigger('change');
                               }, 500);
                           }, 500);
                        }, 500);
                    }
                    $(element+'notification').val(result.model.notification).trigger('change');
                    if(result.customer_info != null){                        
                        $(element+'regime').val(result.customer_info.regime).trigger('change'); 
                        $(element+'regime_special').val(result.customer_info.regime_special).trigger('change');
                        $(element+'great_retainer').val(result.customer_info.great_retainer).trigger('change');
                        $(element+'auto_retainer').val(result.customer_info.auto_retainer).trigger('change');
                        $(element+'type_activity').val(result.customer_info.type_activity).trigger('change');
                        if(result.customer_info.support_bank != ''){                            
                            $(element+'support_bank_file').attr('href', result.customer_info.support_bank).removeClass('hide');
                        }
                    }
                    
                    if(result.model.idProfile != ''){
                        setTimeout(function () {
                            $(element+'idUserProfile').val(result.model.idProfile).trigger('change'); 
                            $(element+'idUserProfile').css('pointer-events','none');
                            $(element+'idCoordinator').css('pointer-events','none');                            
                            setTimeout(function () {
                                $(element+'idCoordinator').val(result.model.idCoordinator).trigger('change');                            
                            }, 500);
                        }, 500);
                    }
                    
                }else{
                    toastr[result.status](result.msg);
                    
                }
            }
        });

    });
    // change state Users
    
    $('body').on('click', '.changeStateUsers', function (e) {
        e.preventDefault();
        var _this = $(this);
        $.ajax({
            url: SITEURL + "/users/changeStateUser",
            dataType: 'json',
            type: 'POST',
            data: {id : _this.attr("data-id"), state : _this.attr("data-state")},
            success: function (result) {
                
                if (result.status == "success") {
                    $('.tooltipped').tooltip('remove');
                    if(result.model.idUserState == 1){
                        _this.attr("data-state" , '2');
                        _this.removeClass("success").addClass('delete');
                        _this.attr("data-tooltip" , 'Inactivar');
                        _this.children('i').removeClass("fa-check").addClass('fa-times');
                    }else{
                        _this.attr("data-state" , '1');
                        _this.removeClass("delete").addClass('success');
                        _this.attr("data-tooltip" , 'Activar');
                        _this.children('i').removeClass("fa-times").addClass('fa-check');                        
                    }
//                    $(".tooltipped").tooltip();                    
                }else{
                    toastr[result.status](result.msg);
                    
                }
            }
        });

    });

});
$(window).on('load', function() {
    setTimeout(function () {
        $('#m-wallets').trigger('click');
        $('#m-customers').addClass('active');
    }, 250);    
});

