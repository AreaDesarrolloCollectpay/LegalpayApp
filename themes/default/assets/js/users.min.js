$(function () {   
    
    // btn create users 

        $('body').on('click', '.createadvisers', function (e) {
            e.preventDefault();
            var _this = $(this);
            var _internal = $('#users-is_internal').val();
            $(".form-users")[0].reset();
            $("#users-id").val('');
            $("#users-is_internal").val(_internal);
            $('#users-idUserProfile').css('pointer-events','');
            $('.select-coordinator').addClass('hide');
        });
        
        $('body').on('click', '.createcoordinators', function (e) {
            e.preventDefault();
            var _this = $(this);
            var _internal = $('#users-is_internal').val();
            $(".form-coordinators")[0].reset();
            $("#users-id").val('');
            $("#users-is_internal").val(_internal);
            $('#users-idUserProfile').css('pointer-events','');
            $('.select-coordinator').addClass('hide');
            $('#users-support_bank_file').attr('href','#').addClass('hide');  
        });

    //  form update User

    $('body').on('submit', '.form-users', function (e) {
        e.preventDefault();
        var _this = $(this);
        var form = new FormData(this);
        $.ajax({
            url: SITEURL + "/users/updateUsers",
            dataType: 'json',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false,
            beforeSend: function () {
                $(".preload").fadeIn(300);
            },
            success: function (result) {
                $(".preload").fadeOut(300);
                toastr[result.status](result.msg);
                if (result.status == "success") {
                    $('.clear').val('');
                    $('.modal-close').click();
                    setTimeout(function(){
                        location.reload();
                    },800);
                }
            }
        });
    });
    
    $('body').on('submit', '.form-coordinators', function (e) {
        e.preventDefault();
        var _this = $(this);
        var form = new FormData(this);
        $.ajax({
            url: SITEURL + "/users/updateCoordinators",
            dataType: 'json',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false,
            beforeSend: function () {
                $(".preload").fadeIn(300);
            },
            success: function (result) {
                $(".preload").fadeOut(300);
                toastr[result.status](result.msg);
                if (result.status == "success") {
                    $('.clear').val('');
                    $('.modal-close').click();
                    setTimeout(function(){
                        location.reload();
                    },800);
                }
            }
        });
    });
    
    // search Coordinators
    
    $('body').on('change','.searchCoordinators',function(){
        var i = 0;
        var urlExplorar = ''
            $('.searchCoordinators').each(function(){
                var _this = $(this);                        
                
                if(_this.val() != ''){                    
                    urlExplorar += (i == 0)? '?'+_this.attr('name')+'='+_this.val() : '&'+_this.attr('name')+'='+_this.val() ;
                    i++;
                }
                
            });                        
            window.location = SITEURL+'/users'+urlExplorar;
            return false;
    });
    
    // search Advisers
    
    $('body').on('change','.searchAdvisers',function(){
        var i = 0;
        var urlExplorar = ''
            $('.searchAdvisers').each(function(){
                var _this = $(this);                        
                
                if(_this.val() != ''){                    
                    urlExplorar += (i == 0)? '?'+_this.attr('name')+'='+_this.val() : '&'+_this.attr('name')+'='+_this.val() ;
                    i++;
                }
                
            });                        
            window.location = SITEURL+'/users/advisers'+urlExplorar;
            return false;
    });
    
    // update Users
    
    $('body').on('click', '.editUsers', function (e) {
        e.preventDefault();
        var _this = $(this);
        var element = "#"+_this.attr("data-element");
        $.ajax({
            url: SITEURL + "/users/getUsers",
            dataType: 'json',
            type: 'POST',
            data: {id : _this.attr("data-id")},
            success: function (result) {
                $('.select-coordinator').addClass('hide');
                $(element+'idUserProfile').css('pointer-events','');
                if (result.status == "success") {
                    $.each(result.info,function(index, value){
                        $(element+index).val(value);
                        console.log(element+index);
                    });
                    $(element+'notification').val(result.model.notification).trigger('change');     
                    if(result.location.idCity != ''){
                        setTimeout(function () {
                            $(element+'idCountry').val(result.location.idCountry).trigger('change');
                            setTimeout(function () {
                               $(element+'idDepartment').val(result.location.idDepartment).trigger('change');
                                setTimeout(function () {
                                   $(element+'idCity').val(result.location.idCity).trigger('change');
                               }, 500);
                           }, 500);
                        }, 500);
                    }
                    if(result.model.idProfile != ''){
                        setTimeout(function () {
                            $(element+'idUserProfile').val(result.model.idProfile).trigger('change'); 
                            $(element+'idUserProfile').css('pointer-events','none');
                            $(element+'idCoordinator').css('pointer-events','none');                            
                            setTimeout(function () {
                                $(element+'idCoordinator').val(result.model.idCoordinator).trigger('change');                            
                            }, 500);
                        }, 500);
                    }
                }else{
                    toastr[result.status](result.msg);
                    
                }
            }
        });

    });
    
    $('body').on('click', '.editCoordinators', function (e) {
        e.preventDefault();
        var _this = $(this);
        var element = "#"+_this.attr("data-element");
        $(element+'support_bank').parent().siblings().children().val('');        
        $(element+'support_bank_file').attr('href','#').addClass('hide');       
        $.ajax({
            url: SITEURL + "/customers/getCustomer",
            dataType: 'json',
            type: 'POST',
            data: {id : _this.attr("data-id")},
            success: function (result) {
                if (result.status == "success"){
                    if(result.customer_info != null){
                        $.each(result.customer_info,function(index, value){
                            if(value != '' && index != 'support_bank'){                                
                               $(element+index).val(value);
                            }
                        }); 
                    }
                    $.each(result.model,function(index, value){
                        $(element+index).val(value);
                    });
                    
                    if(result.location.idCity != ''){
                        setTimeout(function () {
                            $(element+'idCountry').val(result.location.idCountry).trigger('change');
                            setTimeout(function () {
                               $(element+'idDepartment').val(result.location.idDepartment).trigger('change');
                                setTimeout(function () {
                                   $(element+'idCity').val(result.location.idCity).trigger('change');
                               }, 500);
                           }, 500);
                        }, 500);
                    }
                    $(element+'notification').val(result.model.notification).trigger('change');
                    if(result.customer_info != null){                        
                        $(element+'regime').val(result.customer_info.regime).trigger('change'); 
                        $(element+'regime_special').val(result.customer_info.regime_special).trigger('change');
                        $(element+'great_retainer').val(result.customer_info.great_retainer).trigger('change');
                        $(element+'auto_retainer').val(result.customer_info.auto_retainer).trigger('change');
                        $(element+'type_activity').val(result.customer_info.type_activity).trigger('change');
                        if(result.customer_info.support_bank != ''){                            
                            $(element+'support_bank_file').attr('href', result.customer_info.support_bank).removeClass('hide');
                        }
                    }
                    
                    if(result.profile != null){
                        setTimeout(function () {
                            $(element+'idUserProfile').val(result.profile.idProfile).trigger('change'); 
                            $(element+'idUserProfile').css('pointer-events','none');
                            $(element+'idCoordinator').css('pointer-events','none');                            
                            setTimeout(function () {
                                $(element+'idCoordinator').val(result.profile.idCoordinator).trigger('change');                            
                            }, 500);
                        }, 500);
                    }
                    
                    
                }else{
                    toastr[result.status](result.msg);
                    
                }
            }
        });

    });
    // change state Users
    
    $('body').on('click', '.changeStateUsers', function (e) {
        e.preventDefault();
        var _this = $(this);
        $.ajax({
            url: SITEURL + "/users/changeStateUser",
            dataType: 'json',
            type: 'POST',
            data: {id : _this.attr("data-id"), state : _this.attr("data-state")},
            success: function (result) {
                
                if (result.status == "success") {
                    $('.tooltipped').tooltip('remove');
                    if(result.model.active == 1){
                        _this.attr("data-state" , '2');
                        _this.removeClass("success").addClass('delete');
                        _this.attr("data-tooltip" , 'Inactivar');
                        _this.children('i').removeClass("fa-check").addClass('fa-times');
                    }else{
                        _this.attr("data-state" , '1');
                        _this.removeClass("delete").addClass('success');
                        _this.attr("data-tooltip" , 'Activar');
                        _this.children('i').removeClass("fa-times").addClass('fa-check');                        
                    }
//                    $(".tooltipped").tooltip();                    
                }else{
                    toastr[result.status](result.msg);
                    
                }
            }
        });

    });
    
     $('body').on('click', '.getAdvisers', function (e) {
        e.preventDefault();
        var _this = $(this);
        $.ajax({
            url: SITEURL + "/users/getAdvisersCoordinator",
            dataType: 'json',
            type: 'POST',
            data: {id : _this.attr("data-id")},
            success: function (result) {
                if (result.status == "success") {
                   $("#adviserCoordinator").html(result.html);
                }else{
                    toastr[result.status](result.msg);
                    
                }
            }
        });

    });

});

$(window).on('load', function() {
    setTimeout(function () {
        $('#m-wallets').trigger('click');
        $('#m-users').addClass('active');
    }, 250);    
});



