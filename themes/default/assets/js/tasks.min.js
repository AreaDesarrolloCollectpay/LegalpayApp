$(function () {
    
    $(".view_list").addClass("open");
    //select type tasks    
    $('body').on('click','.task-type',function(e){
        e.preventDefault();
        var _this = $(this);        
        var attr = _this.attr('data-type');
        // For some browsers, `attr` is undefined; for others, `attr` is false. Check for both.
        if (typeof attr !== typeof undefined && attr !== false) {
          // Element has this attribute
            $('#form-filter-page').val(1);
            $('#form-filter-type').val(attr).change();
        }        
    });
    
    $('body').on('change','.filter-task',function(e){        
        e.preventDefault();
        getTasks();
    });
    
    $('body').on('change','.filterTask',function(e){        
        e.preventDefault();
        $('#form-filter-page').val(1);
    });
    
    $('body').on('submit','#form-filter-task',function(e){        
        e.preventDefault();
        getTasks();
    });
    
    //var win = $('#tasksToday');
    $('.see-more').click(function(e){
        e.preventDefault();
        var _this = $(this);
        _this.parent().addClass("hide");
        _this.next().removeClass("hide");
        
        var attr = _this.attr('data-page');
        // For some browsers, `attr` is undefined; for others, `attr` is false. Check for both.
        if (typeof attr !== typeof undefined && attr !== false) {
          // Element has this attribute
            $('#form-filter-page').val(attr).change();
        }   
        
        getTasks();
    });
   
    /*win.scroll(function() {
        if (win.scrollTop() == $(document).height() - win.height()) {
            $('.loading').removeClass('hide');
            $('.see-more').trigger('click');
        }
    });*/
    
    $('body').on('change','#searchProfile',function(e){
        e.preventDefault();
        var _this = $(this);
        getUsers(_this);
    });
    
    //Actions Calendar
        $('body').on('click','.clicList',function(e){
            $(".view_calendar").removeClass("open");
            $(".view_list").addClass("open");
        });
        $('body').on('click','.clicCalendar',function(e){
            e.preventDefault();
            getCalendar();
//            console.log('CALENDAR');
            $(".view_list").removeClass("open");
            $(".view_calendar").addClass("open");
        });

        //Filter Task
        $('body').on('click','.btn-filter-task',function(e){
            $(".maskFilter").addClass("open");
            $(".bg_filter_task").addClass("open");
        });
        $('body').on('click','.maskFilter',function(e){
            $(".maskFilter").removeClass("open");
            $(".bg_filter_task").removeClass("open");
        });
        
        //Full Calendar
});

function getTasks(){
    var formElement = document.getElementById('form-filter-task');
    var form = new FormData(formElement); 
    $.ajax({
        url: SITEURL + '/tasks/index',
        dataType: 'json',
        method: 'POST',
        data: form,
        processData: false,
        contentType: false,
        success: function(result) {
            if(result.status == "success"){
                var _this = $('.see-more');
                $("#form-filter-page").val(result.page);
                $(".see-more").attr('data-page',result.page);
                    if(result.page == 2){
                        $('.list_my_task').html(result.html);
                    }else{                        
                        $('.list_my_task').append(result.html);
                    }
                    if(result.more){
                        console.log('true');
                        $(_this).parent().removeClass('hide');
                        $(_this).next().addClass('hide');
                    }else{
                        console.log('false');
                        $(_this).parent().addClass('hide');
                        $(_this).next().addClass('hide');
                    }
                
                //$('.loading'+type).addClass('hide');
            }
        }
    });
}

function getUsers(_this){
    var _id = _this.val();
    $.ajax({
        method: 'POST',
        data: {id:_id},
        url: SITEURL + '/tasks/getUsers',
        dataType: 'json',
        success: function(result) {
            if(result.status == "success"){
               $('#userSearch').html(result.html);
            }
        }
    });
}

function getCalendar(){
    
    var formElement = document.getElementById('form-filter-task');
    var form = new FormData(formElement); 
    var dateEvents;
    $.ajax({
        url: SITEURL + '/tasks/getCalendar',
        dataType: 'json',
        method: 'POST',
        data: form,
        processData: false,
        contentType: false,
        success: function(result) {
            if(result.status == "success"){
               dateEvents = result.data;      
               $('#fullcalendar').fullCalendar('destroy');
                $("#fullcalendar").fullCalendar({
                    header: {
                        left: "prev,next today",
                        center: "title",
                        right: "month,agendaWeek,agendaDay"
                    },
                    locale: "es",
                    // List Events
                    events: dateEvents,
                    eventClick: function (date, calEvent, jsEvent, view) {
                        showModalTask(date.start.format());                        
                    }
                });               
               
            }else{
                toastr[result.status](result.msg);
            }
        }
    }); 
}

function showModalTask(dateTask){
    
    var formElement = document.getElementById('form-filter-task');
    var form = new FormData(formElement); 
    form.append("date", dateTask);
    $.ajax({
        url: SITEURL + '/tasks/getModalTask',
        dataType: 'json',
        method: 'POST',
        data: form,
        processData: false,
        contentType: false,
        success: function(result) {
            if(result.status == "success"){
                $('#modal_title_tasks').html(result.title); 
                $('#modal_content_task').html(result.html); 
            }
            $('#list_task').openModal();
        }
    }); 
}

$(window).on('load', function () {
    setTimeout(function () {
        $('#m-wallets').trigger('click');
        $('#m-tasks').addClass('active');
    }, 250);
});
    