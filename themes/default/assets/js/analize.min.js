$(function () {
    // submit form mlmodels - generate sources and dataset
    
    $('body').on('submit', '.form-mlanalize', function (e) {
        e.preventDefault();
        var form = new FormData(this);
         
        $.ajax({
            url: SITEURL + "/machine/saveMlCentroid",
            dataType: 'json',
            type: 'POST',
            data: form,
            processData: false,
            contentType: false,
            beforeSend: function () {
                progressBar('start');
            },
            success: function (result) {
                if (result.status == "success" || result.status == "waiting") {
                    statusPrediction(result.msg);
                    if (result.status == "success") {
                        createSource(result.model.id);
                    } else {
                        setTimeout(function () {
                            getSource(result.model.id);
                        }, 800);
                    }
                } else {
                    progressBar('finish');
                    toastr[result.status](result.msg);
                }
            }
        });
    });

});

function progressBar(action) {
    console.log('progress2');
    if (action == 'start') {
        $('#content-form-models').hide();
        $('#content-form-status').show();
    } else {
        $('#content-form-status').hide();
        $('#content-form-models').show();
    }
}

function statusPrediction(msg) {
    $('#text-status').html(msg);
}

function createSource(id) {
    console.log('create source');
    $.ajax({
        url: SITEURL + "/analize/createSource",
        dataType: 'json',
        type: 'POST',
        data: {
            id: id,
        },
        beforeSend: function () {
            progressBar('start');
        },
        success: function (result) {
            if (result.status == "success" || result.status == "waiting") {
                statusPrediction(result.msg);
                if (result.status == "success") {
                    createDataset(result.model.id);
                } else {
                    setTimeout(function () {
                        getSource(result.model.id);
                    }, 800);
                }
            } else {
                progressBar('finish');
                toastr[result.status](result.msg);
            }
        }
    });
}

function getSource(id) {
    console.log('getSource');
    $.ajax({
        url: SITEURL + "/analize/getSource",
        dataType: 'json',
        type: 'POST',
        data: {
            id: id
        },
        success: function (result) {
//            $(".preload").fadeOut(300);            
            if (result.status == "success" || result.status == "waiting") {
                statusPrediction(result.msg);
                if (result.status == "success") {
                    createDataset(result.model.id);
                } else {
                    setTimeout(function () {
                        getSource(result.model.id);
                    }, 10000);
                }
            } else {
                progressBar('finish');
                toastr[result.status](result.msg);
            }
        }
    });
}

function createDataset(id) {
    console.log('createDataset');
    $.ajax({
        url: SITEURL + "/analize/createDataset",
        dataType: 'json',
        type: 'POST',
        data: {
            id: id
        },
        success: function (result) {
//            $(".preload").fadeOut(300);            
            if (result.status == "success" || result.status == "waiting") {
                statusPrediction(result.msg);
                if (result.status == "success") {
                    createCluster(result.model.id);
                } else {
                    setTimeout(function () {
                        getDataset(result.model.id);
                    }, 10000);
                }
            } else {
                progressBar('finish');
                toastr[result.status](result.msg);
            }
        }
    });
}

function getDataset(id) {
    console.log('getDataset');
    $.ajax({
        url: SITEURL + "/analize/getDataset",
        dataType: 'json',
        type: 'POST',
        data: {
            id: id,
        },
        success: function (result) {
//            $(".preload").fadeOut(300);            
            if (result.status == "success" || result.status == "waiting") {
                statusPrediction(result.msg);
                if (result.status == "success") {
                    createBatchCentroid(result.model.id);
                } else {
                    setTimeout(function () {
                        getDataset(result.model.id);
                    }, 10000);
                }
            } else {
                progressBar('finish');
                toastr[result.status](result.msg);
            }
        }
    });
}

function createBatchCentroid(id,type) {
    console.log('createBatchCentroid');
    $.ajax({
        url: SITEURL + "/analize/createBatchCentroid",
        dataType: 'json',
        type: 'POST',
        data: {
            id: id, type: type
        },
        success: function (result) {
//            $(".preload").fadeOut(300);            
            if (result.status == "success" || result.status == "waiting") {
                statusPrediction(result.msg);
                if (result.status == "success") {
                    downloadBatchCentroid(id,type);
                } else {
                    setTimeout(function () {
                       getBatchCentroid(id,type);
                    }, 10000);
                }
            } else {
                progressBar('finish');
                toastr[result.status](result.msg);
            }
        }
    });
}

function getBatchCentroid(id,type) {
    console.log('getBatchCentroid');
    $.ajax({
        url: SITEURL + "/analize/getBatchCentroid",
        dataType: 'json',
        type: 'POST',
        data: {
            id: id, type: type
        },
        success: function (result) {
//            $(".preload").fadeOut(300);            
            if (result.status == "success" || result.status == "waiting") {
                statusPrediction(result.msg);
                if (result.status == "success") {
                    downloadBatchCentroid(id,type);
                } else {
                    setTimeout(function () {
                       getBatchCentroid(id,type);
                    }, 10000);
                }
            } else {
                progressBar('finish');
                toastr[result.status](result.msg);
            }
        }
    });
}

function downloadBatchCentroid(id,type){
    console.log('downloadBatchCentroid');
    $.ajax({
        url: SITEURL + "/analize/downloadBatchCentroid",
        dataType: 'json',
        type: 'POST',
        data: {
            id: id, type: type
        },
        success: function (result) {
//            $(".preload").fadeOut(300);            
            if (result.status == "success" || result.status == "waiting") {
                statusPrediction(result.msg);
                if (result.status == "success") {
                    location.href = SITEURL+"/machine";  
                }
                else {
                    setTimeout(function () {
                       downloadBatchCentroid(id,type);
                    }, 10000);
                }
            } else {
                progressBar('finish');
                toastr[result.status](result.msg);
            }
        }
    });
}


$(window).on('load', function () {
    setTimeout(function () {
        $('#m-wallets').trigger('click');
        $('#m-machine').addClass('active');
    }, 250);
});